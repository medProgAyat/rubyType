<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>gtypist Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø±</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e2f;
            color: #f0f0f0;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            direction: rtl;
        }
        .container {
            background: #2d2d3a;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #ffd966;
        }
        select, button {
            font-size: 16px;
            padding: 8px 12px;
            margin: 5px;
            border-radius: 5px;
            border: none;
            font-family: inherit;
        }
        button {
            background: #4caf50;
            color: white;
            cursor: pointer;
            transition: 0.2s;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        .lesson-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 30px;
        }
        .target-line {
            background: #0f0f1a;
            padding: 15px;
            border-radius: 8px;
            font-size: 24px;
            letter-spacing: 2px;
            text-align: center;
            margin-bottom: 20px;
            border: 2px solid #4a4a6a;
            direction: ltr;
            font-weight: bold;
            color: #bbffbb;
        }
        .input-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        #userInput {
            width: 100%;
            max-width: 600px;
            font-size: 22px;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #6a6a8a;
            background: #0f0f1a;
            color: #f0f0f0;
            text-align: center;
            font-family: 'Courier New', monospace;
            direction: ltr;
            outline: none;
        }
        #userInput:focus {
            border-color: #ffd966;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            background: #1a1a2e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 18px;
            flex-wrap: wrap;
        }
        .stat-item {
            text-align: center;
            min-width: 120px;
        }
        .stat-label {
            color: #aaa;
            font-size: 14px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #ffd966;
        }
        .progress {
            text-align: center;
            margin-bottom: 20px;
            font-size: 16px;
            color: #ccc;
        }
        .actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .error-message {
            color: #ff6b6b;
            text-align: center;
            margin-top: 10px;
            font-size: 16px;
        }
        footer {
            text-align: center;
            margin-top: 30px;
            color: #6a6a8a;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âŒ¨ï¸ ØªÙ…Ø±ÛŒÙ† ØªØ§ÛŒÙ¾ Ø¨Ø§ gtypist (Ù†Ø³Ø®Ù‡ ÙˆØ¨)</h1>

        <div class="lesson-selector">
            <select id="lessonSelect">
                <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø±Ø³ --</option>
                <% lessons.each do |lesson| %>
                    <option value="<%= lesson['id'] %>"><%= lesson['name'] %></option>
                <% end %>
            </select>
            <button id="startBtn" disabled>Ø´Ø±ÙˆØ¹ Ø¯Ø±Ø³</button>
        </div>

        <div id="exerciseArea" style="display: none;">
            <div class="target-line" id="targetLine"></div>

            <div class="input-area">
                <input type="text" id="userInput" placeholder="Ø§ÛŒÙ†Ø¬Ø§ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯ ..." autocomplete="off" dir="ltr">
            </div>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-label">Ø³Ø±Ø¹Øª Ø®Ø· (WPM)</div>
                    <div class="stat-value" id="lineWpm">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Ø¯Ù‚Øª Ø®Ø·</div>
                    <div class="stat-value" id="lineAccuracy">100%</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ØºÙ„Ø·â€ŒÙ‡Ø§ÛŒ Ø®Ø·</div>
                    <div class="stat-value" id="lineErrors">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Ú©Ù„ Ø¯Ø±Ø³ (WPM)</div>
                    <div class="stat-value" id="totalWpm">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Ø¯Ù‚Øª Ú©Ù„</div>
                    <div class="stat-value" id="totalAccuracy">100%</div>
                </div>
            </div>

            <div class="progress">
                Ø®Ø· <span id="currentLineNum">1</span> Ø§Ø² <span id="totalLines">0</span>
            </div>

            <div class="actions">
                <button id="nextBtn" disabled>Ø®Ø· Ø¨Ø¹Ø¯ÛŒ</button>
                <button id="resetBtn">Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ Ø¯Ø±Ø³</button>
            </div>

            <div id="errorMsg" class="error-message"></div>
        </div>
    </div>

    <footer>Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§ Ruby (Sinatra) Ùˆ â¤ï¸</footer>

    <script>
        // Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ø³ Ø§Ø² Ø³Ø±ÙˆØ± (Ø§Ø² Ø·Ø±ÛŒÙ‚ locals Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡)
        const initialLessons = <%= lessons.to_json %>;

        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ ÙˆØ¶Ø¹ÛŒØª
        let currentLesson = null;               // { id, name, lines }
        let currentLineIndex = 0;
        let lessonLines = [];
        let lineStartTime = null;
        // Ø¢Ù…Ø§Ø± ØªØ¬Ù…Ø¹ÛŒ
        let totalCorrect = 0;
        let totalErrors = 0;
        // Ø¢Ù…Ø§Ø± Ø®Ø· Ø¬Ø§Ø±ÛŒ
        let lineCorrect = 0;
        let lineErrors = 0;

        // Ø¹Ù†Ø§ØµØ± DOM
        const lessonSelect = document.getElementById('lessonSelect');
        const startBtn = document.getElementById('startBtn');
        const exerciseArea = document.getElementById('exerciseArea');
        const targetLineDiv = document.getElementById('targetLine');
        const userInput = document.getElementById('userInput');
        const lineWpmSpan = document.getElementById('lineWpm');
        const lineAccuracySpan = document.getElementById('lineAccuracy');
        const lineErrorsSpan = document.getElementById('lineErrors');
        const totalWpmSpan = document.getElementById('totalWpm');
        const totalAccuracySpan = document.getElementById('totalAccuracy');
        const currentLineNumSpan = document.getElementById('currentLineNum');
        const totalLinesSpan = document.getElementById('totalLines');
        const nextBtn = document.getElementById('nextBtn');
        const resetBtn = document.getElementById('resetBtn');
        const errorMsg = document.getElementById('errorMsg');

        // ÙˆÙ‚ØªÛŒ Ø¯Ø±Ø³ Ø§Ø² Ù„ÛŒØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ Ø¯Ú©Ù…Ù‡ Ø´Ø±ÙˆØ¹ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯
        lessonSelect.addEventListener('change', function() {
            startBtn.disabled = !this.value;
        });

        // Ø´Ø±ÙˆØ¹ Ø¯Ø±Ø³
        startBtn.addEventListener('click', function() {
            const lessonId = lessonSelect.value;
            if (!lessonId) return;

            // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø³Ù„Ú©ØªÙˆØ± Ùˆ Ø¯Ú©Ù…Ù‡ Ø´Ø±ÙˆØ¹
            lessonSelect.disabled = true;
            startBtn.disabled = true;

            // Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø±Ø³ Ø§Ø² Ø³Ø±ÙˆØ±
            fetch(`/api/lessons/${lessonId}`)
                .then(res => res.json())
                .then(lesson => {
                    currentLesson = lesson;
                    lessonLines = lesson.lines;
                    resetLesson();
                    exerciseArea.style.display = 'block';
                    totalLinesSpan.textContent = lessonLines.length;
                    userInput.focus();
                })
                .catch(err => {
                    errorMsg.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø³.';
                });
        });

        // Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø¯Ø±Ø³ (Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ ÛŒØ§ Ø¨Ø¹Ø¯ Ø§Ø² ØªØºÛŒÛŒØ± Ø®Ø·)
        function resetLesson() {
            currentLineIndex = 0;
            totalCorrect = 0;
            totalErrors = 0;
            lineCorrect = 0;
            lineErrors = 0;
            lineStartTime = null;
            updateLineDisplay();
            updateStats();
            userInput.value = '';
            userInput.disabled = false;
            nextBtn.disabled = true;
            errorMsg.textContent = '';
        }

        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø®Ø· Ø¬Ø§Ø±ÛŒ
        function updateLineDisplay() {
            if (!lessonLines.length) return;
            targetLineDiv.textContent = lessonLines[currentLineIndex];
            currentLineNumSpan.textContent = currentLineIndex + 1;
        }

        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¢Ù…Ø§Ø± Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ±ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø±
        function computeStats(inputText) {
            const target = lessonLines[currentLineIndex];
            const len = Math.max(inputText.length, target.length);
            let correct = 0;
            let errors = 0;

            for (let i = 0; i < len; i++) {
                if (i >= inputText.length) {
                    // Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ Ù‡Ø¯Ù Ú©Ù‡ ØªØ§ÛŒÙ¾ Ù†Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯: Ø®Ø·Ø§ Ù…Ø­Ø³ÙˆØ¨ Ù†Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ (Ù‡Ù†ÙˆØ² ÙØ±ØµØª Ù‡Ø³Øª)
                    // Ø§Ù…Ø§ Ø¯Ø± gtypist Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ù†Ø§Ù‚Øµ ØªØ§ÛŒÙ¾ Ú©Ø±Ø¯Ù† ØªØ§ Ù¾Ø§ÛŒØ§Ù† Ø®Ø· Ø®Ø·Ø§ Ù†Ø¯Ø§Ø±Ø¯.
                    // Ù…Ø§ ÙÙ‚Ø· Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ ØªØ§ÛŒÙ¾ Ø´Ø¯Ù‡ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….
                    break;
                }
                if (i >= target.length) {
                    // Ø§Ø¶Ø§ÙÛŒ ØªØ§ÛŒÙ¾ Ø´Ø¯Ù‡: Ø®Ø·Ø§
                    errors++;
                } else if (inputText[i] === target[i]) {
                    correct++;
                } else {
                    errors++;
                }
            }

            return { correct, errors };
        }

        // Ø±ÙˆÛŒØ¯Ø§Ø¯ ØªØ§ÛŒÙ¾ Ø¯Ø± input
        userInput.addEventListener('input', function() {
            if (!lessonLines.length) return;

            // Ø´Ø±ÙˆØ¹ ØªØ§ÛŒÙ…Ø± Ø§Ú¯Ø± Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø± Ø§Ø³Øª
            if (lineStartTime === null && this.value.length > 0) {
                lineStartTime = Date.now();
            }

            const input = this.value;
            const { correct, errors } = computeStats(input);

            lineCorrect = correct;
            lineErrors = errors;

            // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ø¨Ø¹Ø¯ÛŒ Ø§Ú¯Ø± Ø·ÙˆÙ„ ÙˆØ±ÙˆØ¯ÛŒ Ø­Ø¯Ø§Ù‚Ù„ Ø¨Ù‡ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ù‡Ø¯Ù Ø¨Ø§Ø´Ø¯
            const target = lessonLines[currentLineIndex];
            if (input.length >= target.length) {
                nextBtn.disabled = false;
            } else {
                nextBtn.disabled = true;
            }

            updateStats();
        });

        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø±
        function updateStats() {
            // Ø¢Ù…Ø§Ø± Ø®Ø·
            lineErrorsSpan.textContent = lineErrors;
            const totalLineTyped = lineCorrect + lineErrors;
            const lineAcc = totalLineTyped > 0 ? (lineCorrect / totalLineTyped * 100).toFixed(1) : 100;
            lineAccuracySpan.textContent = lineAcc + '%';

            // Ø³Ø±Ø¹Øª Ø®Ø· (WPM)
            if (lineStartTime && lineCorrect > 0) {
                const elapsedMinutes = (Date.now() - lineStartTime) / 60000;
                const wpm = (lineCorrect / 5) / elapsedMinutes;
                lineWpmSpan.textContent = wpm.toFixed(1);
            } else {
                lineWpmSpan.textContent = '0';
            }

            // Ø¢Ù…Ø§Ø± Ú©Ù„
            const totalTyped = totalCorrect + totalErrors + lineCorrect + lineErrors;
            const totalAcc = totalTyped > 0 ? ((totalCorrect + lineCorrect) / totalTyped * 100).toFixed(1) : 100;
            totalAccuracySpan.textContent = totalAcc + '%';

            // Ø³Ø±Ø¹Øª Ú©Ù„ (Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø¬Ù…ÙˆØ¹ Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ Ø¯Ø±Ø³Øª)
            if (lineStartTime && (totalCorrect + lineCorrect) > 0) {
                // Ø²Ù…Ø§Ù† Ú©Ù„ Ø§Ø² Ø´Ø±ÙˆØ¹ Ø§ÙˆÙ„ÛŒÙ† Ø®Ø· ØªØ§ Ø§Ù„Ø§Ù† ØªÙ‚Ø±ÛŒØ¨ÛŒ Ø§Ø³ØªØŒ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ú¯ÛŒ Ø§Ø² Ù‡Ù…Ø§Ù† Ø²Ù…Ø§Ù† Ø®Ø· Ø¬Ø§Ø±ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                // Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ø²Ù…Ø§Ù† Ú©Ù„ Ø±Ø§ Ø§Ø² Ø§Ø¨ØªØ¯Ø§ÛŒ Ø¯Ø±Ø³ Ø­Ø³Ø§Ø¨ Ú©Ø±Ø¯ØŒ Ø§Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ú¯ÛŒ Ù‡Ù…ÛŒÙ† Ø¨Ø³Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….
                const elapsedMinutes = (Date.now() - (lineStartTime || Date.now())) / 60000;
                const totalWpm = ((totalCorrect + lineCorrect) / 5) / (elapsedMinutes || 0.001);
                totalWpmSpan.textContent = totalWpm.toFixed(1);
            } else {
                totalWpmSpan.textContent = '0';
            }
        }

        // Ø­Ø±Ú©Øª Ø¨Ù‡ Ø®Ø· Ø¨Ø¹Ø¯ÛŒ
        function goToNextLine() {
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¢Ù…Ø§Ø± Ø®Ø· Ø¬Ø§Ø±ÛŒ Ø¨Ù‡ Ú©Ù„
            totalCorrect += lineCorrect;
            totalErrors += lineErrors;

            // Ø±ÛŒØ³Øª Ø¢Ù…Ø§Ø± Ø®Ø·
            lineCorrect = 0;
            lineErrors = 0;
            lineStartTime = null;
            userInput.value = '';
            nextBtn.disabled = true;

            // Ø­Ø±Ú©Øª Ø¨Ù‡ Ø®Ø· Ø¨Ø¹Ø¯
            if (currentLineIndex + 1 < lessonLines.length) {
                currentLineIndex++;
                updateLineDisplay();
                userInput.focus();
            } else {
                // Ù¾Ø§ÛŒØ§Ù† Ø¯Ø±Ø³
                userInput.disabled = true;
                targetLineDiv.textContent = 'ğŸ‰ Ø¯Ø±Ø³ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯! ØªØ¨Ø±ÛŒÚ©!';
                nextBtn.disabled = true;
            }

            updateStats();
        }

        nextBtn.addEventListener('click', goToNextLine);

        // Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ Ø¯Ø±Ø³
        resetBtn.addEventListener('click', function() {
            if (!currentLesson) return;
            resetLesson();
            userInput.focus();
        });

        // Ø§Ù…Ú©Ø§Ù† Ø²Ø¯Ù† Enter Ø¨Ø±Ø§ÛŒ Ø±ÙØªÙ† Ø¨Ù‡ Ø®Ø· Ø¨Ø¹Ø¯ÛŒ
        userInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !nextBtn.disabled) {
                e.preventDefault();
                goToNextLine();
            }
        });

        // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† form submit Ù¾ÛŒØ´â€ŒÙØ±Ø¶
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>
